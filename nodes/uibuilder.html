<!--
    Copyright (c) 2019 Julian Knight (Totally Information)

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->

<script type="text/javascript">
    /* eslint-env browser */
    /* global $,RED */
    // @ts-check
    'use strict'

    /** Module name must match this nodes html file @constant {string} moduleName */
    var moduleName  = 'uibuilder'

    /** placeholder for url duplicate check - marks url invalid/valid on change */
    var urlIsDup = false

    /** placeholder for ACE editor vars - so that they survive close/reopen admin config ui
     * @typedef uiace
     * @type {Object}
     * @property {string} format
     * @property {string} folder
     * @property {string} fname
     */
    var uiace = {
        'format': 'html',
        'folder': 'src',
        'fname' : 'index.html'
    }

    /** Get full package list via API and show in admin ui
     * param {string} url 
     * param {boolean} rebuild - Rebuild the vendorPaths list
     */
    function packageList() {
        $.getJSON('uibvendorpackages', function(vendorPackages) {
            console.log('uibuilder:packageList:uibvendorpackages', vendorPackages)
            //$('#installed-packages').text( Object.keys(vendorPackages) )
            $('#installed-packages').empty()
            $.each(vendorPackages, function(npmpackage, pkgInfo) {
                $('#installed-packages').append('<li><i>' + npmpackage + '</i></li>')
            })
        })
    } // --- End of packageList --- //

    /** Return a file type from a file name (or default to txt)
     *  ftype can be used in ACE editor modes */
    function fileType(fname) {
        const fparts = fname.split('.')
        if (fparts.length > 1) {
            let ftype = 'text'
            const fext = fparts[1].toLowerCase().trim()
            switch (fext) {
                case 'js':
                    ftype = 'javascript'
                    break
                case 'html':
                case 'css':
                case 'json':
                    ftype = fext
                    break
                case 'vue':
                    ftype = 'html'
                    break
                case 'md':
                    ftype = 'markdown'
                    break
                case 'yaml':
                case 'yml':
                    ftype = 'yaml'
                    break
                default:
                    // txt
            }
            return ftype
        } else {
            return 'text'
        }
    } // --- End of fileType --- //

    /** Get the list of files for the chosen url & folder */
    function getFileList() {
        $('#node-input-filename option').remove()

        var url = $('#node-input-url').val()
        var folder = $('#node-input-folder').val()

        // Build the file list - pass the url so the BE can find the right folder
        $.getJSON('uibfiles?url=' + url + '&folder=' + folder, function(files) {
            var firstFile = ''

            $.each(files, function (i, fname) {
                // Choose the default file
                if ( i === 0 ) firstFile = fname
                if ( fname === 'index.html' ) firstFile = fname
                // Build the drop-down
                $('#node-input-filename').append($('<option>', { 
                    value: fname,
                    text : fname, 
                }))
            })

            //console.log( '[uibuilder:getFileList:getJSON] Got files ', files, firstFile, folder, url )

            // Set default file name/type
            uiace.fname = firstFile
            $('#node-input-filename').val(uiace.fname)
            uiace.format = firstFile === '' ? 'text' : fileType(firstFile)
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.error( '[uibuilder:getFileList:getJSON] Error ' + textStatus, errorThrown )
            uiace.fname = ''
            uiace.format = 'text'
        }).always(function() {
            getFileContents()
            fileIsClean(true)
        })
    }

    /** Get the chosen file contents & set up the ACE editor */
    function getFileContents() {
        /** Get the chosen folder name - use the default/last saved on first load 
         * @type {string} */ 
         // @ts-ignore
        const folder = $('#node-input-folder').val() || uiace.folder 
        /** Get the chosen filename - use the default/last saved on first load 
         * @type {string} */
         // @ts-ignore
        const fname = $('#node-input-filename').val() || uiace.fname
        // Get the current url
        const url = $('#node-input-url').val()

        //console.log( '[uibuilder:getFileContents] ', url, folder, fname )

        // Save the file & folder names
        uiace.folder = folder
        uiace.fname = fname

        // Change mode to match file type
        const filetype = fname === '' ? 'text' : fileType(fname)
        $("#node-input-format").val(filetype)

        // Get the file contents via API defined in uibuilder.js
        $.get( 'uibgetfile?url=' + url + '&fname=' + fname + '&folder=' + folder, function(data){
            //console.log( '[uibuilder:getFileContents:get] Success. ', url, folder, fname )
            // Add the fetched data to the editor
            uiace.editorSession.setValue(data)
            // Set the editor file mode
            uiace.editorSession.setMode({
                path: 'ace/mode/' + filetype, v: Date.now()
            })
            // Mark the current session as clean
            uiace.editorSession.getUndoManager().isClean()
            // Position the cursor in the edit area
            uiace.editor.focus()
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.error( '[uibuilder:getFileContents:get] Error ' + textStatus, errorThrown )
            uiace.editorSession.setValue('')
        })
    } // --- End of getFileContents --- //

    /** Enable/disable buttons if file has edits or not
     * @param {boolean} isClean true = the file is clean, else there are pending edits that need saving
     */
    function fileIsClean(isClean) {
        // If clean, disable the save & reset buttons
        $('#edit-save').prop('disabled', isClean)
        $('#edit-reset').prop('disabled', isClean)
        // If clean, enable the delete and edit buttons
        //$('#edit-delete').prop('disabled', !isClean)
        $('#edit-close').prop('disabled', !isClean)
        $('#node-edit-file').prop('disabled', !isClean)
        $('#node-input-filename').prop('disabled', !isClean)
        // If not clean, disable main Done and Cancel buttons to prevent loss
        $('#node-dialog-ok').prop('disabled', !isClean)
        $('#node-dialog-cancel').prop('disabled', !isClean)
        // If not clean, Add a user hint
        if ( ! isClean ) {
            $('#file-action-message').text('Save Required')
            $('#node-dialog-ok').css( 'cursor', 'not-allowed' )
            $('#node-dialog-cancel').css( 'cursor', 'not-allowed' )
        } else {
            $('#node-dialog-ok').css( 'cursor', 'pointer' )
            $('#node-dialog-cancel').css( 'cursor', 'pointer' )
        }
    } // --- End of fileIsClean --- //

    /** Validation Function: Validate the url property
     * Max 20 chars, can't contain any of ['..', ]
     * @param {*} value The url value to validate
     * @returns {boolean} true = valid
     **/
    function validateUrl(value){
        // NB: `this` is the node instance configuration as at last press of Done
        // TODO: Add display comment to help user

        // Max 20 chars
        if ( value.length > 20 ) return false
        // Cannot contain ..
        if ( value.indexOf('..') !== -1 ) return false
        // cannot contain / or \
        if ( value.indexOf('/') !== -1 ) return false
        if ( value.indexOf('\\') !== -1 ) return false
        // Cannot start with _ or .
        if ( value.substring(0,1) === '_' ) return false
        if ( value.substring(0,1) === '.' ) return false
        // Cannot be 'templates' as this is a reserved value (for v2)
        if ( value.toLowerCase().substring(0,9) === 'templates' ) return false

        // Initial flow run and Initial load of admin config ui - don't check for dups as it always will be
        if ( value === this.url ) return true
        
        // Check whether the url is already in use via a call to the admin API `uibindex`
        var exists = false
        $.ajax({
            dataType: 'json', async: false, 
            url: 'uibindex?check=' + value,
            success: function(check) {
                exists = check
            }
        })

        /** If the url already exists - prevent the "Done" button from being pressed. */
         // @ts-ignore ts(2367)
        if ( exists === true ) {
            $('#node-dialog-ok').prop('disabled', true)
            $('#node-dialog-ok').css( 'cursor', 'not-allowed' )
            return false
        } else {
            $('#node-dialog-ok').prop('disabled', false)
            $('#node-dialog-ok').css( 'cursor', 'pointer' )
            return true
        }

    } // --- End of validateUrl --- //

    // Register the node type, defaults and set up the edit fns 
     //@ts-ignore 
    RED.nodes.registerType('uibuilder', {
        category: 'UI Builder',
        color: '#E6E0F8',
        defaults: {
            name: { value: '' },
            topic: { value: '' },
            url: { value: 'uibuilder', required: true, validate: validateUrl },
            fwdInMessages: { value: false },   // Should we send input msg's direct to output as well as the front-end?
            allowScripts: { value: false },    // Should we allow msg's to send JavaScript to the front-end?
            allowStyles: { value: false },     // Should we allow msg's to send CSS styles to the front-end?
            debugFE: { value: false },         // Should debug be turned on in the uibuilderfe library?
            copyIndex: { value: true },        // Should the default template files be copied to the instance src folder?
        },
        inputs: 1,
        inputLabels: 'Msg to send to front-end',
        outputs: 2,
        outputLabels: ['Data from front-end', 'Control Msgs from front-end'],
        icon: 'ui_template.png',
        paletteLabel: 'UI Builder',
        label: function () { return this.url || this.name || 'UI Builder'; },

        oneditprepare: function () {
            const that = this

            // Start with the edit section hidden & main section visible
            $('#main-props').show()
            $('#edit-props').hide()
            $('#npm-props').hide()
            $('#adv-props').hide()
            $('#info-props').hide()

            // Set the checkbox states
            $('#node-input-fwdInMessages').prop('checked', this.fwdInMessages)
            $('#node-input-allowScripts').prop('checked', this.allowScripts)
            $('#node-input-allowStyles').prop('checked', this.allowStyles)
            $('#node-input-debugFE').prop('checked', this.debugFE)
            $('#node-input-copyIndex').prop('checked', this.copyIndex)
            // Show the uibuilder global settings from settings.js
            // TODO Fix for updated settings
            //$('#bedebug').text(RED.settings.uibuilder.debug)

            // TODO Move to top
            /** AddItem function for package list
             * @param {JQuery<HTMLElement>} element the jQuery DOM element to which any row content should be added
             * @param {number} index the index of the row
             * @param {*} data data object for the row. {} if add button pressed, else data passed to addItem method
             */
            function addPackageRow(element,index,data) {
                var hRow = ''
                if (Object.entries(data).length === 0) {
                    // Add button was pressed so we have no packageName, create an input form instead
                    hRow='<input type="text" id="packageList-input-' + index + '"> <button id="packageList-button-' + index + '">Install</button>'
                } else {
                    // addItem method was called with a packageName passed
                    hRow = data
                }
                // Build the output row
                $('<div class="packageList-row-data">'+hRow+'</div>').appendTo(element)
                // Create a button click listener for the install button for this row
                $('#packageList-button-' + index).click(function(){
                    console.log('.packageList-row-data button::click', $('#packageList-input-' + index).val() )
                    // TODO Call the npm installPackage API (it updates the package list)
                    // TODO If successful, 
                    //   TODO change the row, remove input field & button
                    //   TODO Add to local package list (saves a call to the api)
                    // TODO otherwise highlight input
                })
            }

            // Setup the package list
            $('#node-input-packageList').editableList({
                addItem: addPackageRow,
                removeItem: function(data){},
                resizeItem: function(row,index) {},
                header: $('<div>').append('<h4 style="display: inline-grid">Installed Packages</h4>'),
                height: 'auto',
                addButton: true,
                removable: true,
                scrollOnAdd: true,
                sortable: false,
            })

            /** Initialise default values for package list
             * NOTE: This is build dynamically each time the edit panel is opened
             *       we are not saving this since external changes would result in
             *       users having being prompted to deploy even when they've made
             *       no changes themselves to a node instance.
             */
            // TODO Check for installed packages first to build the local package list
            var pl = ['vue','bootstrap-vue','bootstrap']
            pl.forEach((packageName,i,array) => {
                packageName = pl[i]
                $('#node-input-packageList').editableList('addItem',packageName)
            })

            // When the url changes (NB: Also see the validation function)
            $('#node-input-url').change(function () {
                // Show the root URL
                 // @ts-ignore Cannot find name 'RED'.ts(2304)
                $('#uibuilderurl').empty().append('<a href="' + RED.settings.httpNodeRoot + $(this).val() + '">' + RED.settings.httpNodeRoot + $(this).val() + '</a>')
            })

            // Show/Hide the advanced settings
            $('#show-adv-props').css( 'cursor', 'pointer' )
            $('#show-adv-props').click(function(e) {
                $('#adv-props').toggle()
                if ( $('#adv-props').is(':visible') ) {
                    $('#show-adv-props').html('<i class="fa fa-caret-down"></i> Advanced Settings')
                } else {
                    $('#show-adv-props').html('<i class="fa fa-caret-right"></i> Advanced Settings')
                }
            })
            // Show/Hide the Path & Module info
            $('#show-info-props').css( 'cursor', 'pointer' )
            $('#show-info-props').click(function(e) {
                $('#info-props').toggle()
                if ( $('#info-props').is(':visible') ) {
                    $('#show-info-props').html('<i class="fa fa-caret-down"></i> Path &amp; Module Info')
                } else {
                    $('#show-info-props').html('<i class="fa fa-caret-right"></i> Path &amp; Module Info')
                }
            })

            // List the front-end url paths available (shown in info box)
            //packageList(this.url, true)

            //#region ---- File Editor ---- //
            // Delete is not ready yet, so disable button by default. TODO
            $('#edit-delete').prop('disabled', true)
            // Mark edit save/reset buttons as disabled by default
            fileIsClean(true)

            // Show the edit section, hide the main & adv sections
            $('#show-edit-props').click(function(e) {
                e.preventDefault() // don't trigger normal click event
                $('#main-props').hide()
                $('#adv-props').hide()
                $('#show-adv-props').html('<i class="fa fa-caret-right"></i> Advanced Settings')
                $('#edit-props').show()

                // Make the horizontal separator draggable
                $('#node-input-template-editor').resizable({
                    'handles': 's'
                })
                $('#node-input-template-editor > div.ui-resizable-handle.ui-resizable-s').css({
                    'height': '25px',
                    'bottom': '-25px'
                }
                )

                // @since 2019-01-27 - adding file editor
                // Build the file list
                getFileList()

                if ( uiace.editorLoaded !== true ) {
                    // Clear out the editor
                        // @ts-ignore ts(2367)
                    if ($('#node-input-template').val('') !== '') $('#node-input-template').val('')

                    // Create the ACE editor component
                        //@ts-ignore Cannot find name 'RED'.ts(2304)
                    uiace.editor = RED.editor.createEditor({
                        id: 'node-input-template-editor',
                        mode: 'ace/mode/' + uiace.format,
                        value: that.template
                    })
                    // Keep a reference to the current editor session
                    uiace.editorSession = uiace.editor.getSession()
                    /** If the editor has changes, enable the save & reset buttons
                     * using input event instead of change since it's called with some timeout 
                     * which is needed by the undo (which takes some time to update)
                     **/
                    uiace.editor.on("input", function() {
                        // Is the editor clean?
                        fileIsClean(uiace.editorSession.getUndoManager().isClean())
                    })
                    /*uiace.editorSession.on('change', function(delta) {
                        // delta.start, delta.end, delta.lines, delta.action
                        console.log('ACE Editor CHANGE Event', delta)
                    }) */
                    uiace.editorLoaded = true

                    // Be friendly and auto-load the initial file via the admin API
                    getFileContents()
                    fileIsClean(true)
                }
            })

            // Hide the edit section, show the main section
            $('#edit-close').click(function(e) {
                e.preventDefault() // don't trigger normal click event
                $('#main-props').show()
                $('#edit-props').hide()
            })

            // Handle the file editor change of folder/file
            $('#node-input-folder').change(function(e) {
                // Rebuild the file list
                getFileList()

                // Force change event on filename
                //$('#node-input-filename').change()
            })
            $('#node-input-filename').change(function(e) {
                // Get the content of the file via the admin API
                getFileContents()
                fileIsClean(true)
            })
            // Handle the file editor reset button (reload the file)
            $('#edit-reset').click(function(e) {
                e.preventDefault() // don't trigger normal click event

                // Get the content of the file via the admin API
                getFileContents()
                fileIsClean(true)
                $('#file-action-message').text('')
            })
            // Handle the file editor save button
            $('#edit-save').click(function(e) {
                e.preventDefault() // don't trigger normal click event

                var authTokens = RED.settings.get('auth-tokens')
                console.log(RED.settings.get("auth-tokens"))

                // Post the updated content of the file via the admin API
                // NOTE: Cannot use jQuery POST function as it sets headers that trigger a CORS error. Do it using native requests only.
                var request = new XMLHttpRequest()
                var params = 'fname=' + $('#node-input-filename').val() + '&url=' + $('#node-input-url').val() + '&data=' + encodeURIComponent(uiace.editorSession.getValue())
                request.open('POST', 'uibputfile', true)
                request.onreadystatechange = function() {
                    if (this.readyState === XMLHttpRequest.DONE) {
                        if (this.status === 200) {
                            // Request successful
                            // display msg - blank msg when new edits present
                            $('#file-action-message').text('File Saved')
                            fileIsClean(true)
                        } else {
                            // Request failed
                            // display msg - blank msg when new edits present
                            $('#file-action-message').text('File Save FAILED')
                        }
                    }
                }
                request.setRequestHeader('Content-type', 'application/x-www-form-urlencoded')
                if (authTokens) request.setRequestHeader('Authorization', 'Bearer ' + authTokens.access_token)
                request.send(params)

            })

            // Handle the expander button (show full screen editor) - from core function node
            $('#node-function-expand-js').click(function(e) {
                e.preventDefault()
                var value = uiace.editor.getValue()
                //@ts-ignore Cannot find name 'RED'.ts(2304)
                RED.editor.editJavaScript({
                    value: value,
                    width: 'Infinity',
                    cursor: uiace.editor.getCursorPosition(),
                    mode: 'ace/mode/' + uiace.format,
                    complete: function(v,cursor) {
                        uiace.editor.setValue(v, -1)
                        uiace.editor.gotoLine(cursor.row+1,cursor.column,false)
                        setTimeout(function() {
                            uiace.editor.focus()
                        },300)
                    }
                })
            })
            //#endregion ---- File Editor ---- //

            //#region ---- npm ---- //
            $('#npm-response').hide()
            /** @type {string[]} */
            var npmMsg = []
            // NB: Assuming that the edit section is closed
            // Show the npm section, hide the main & adv sections
            $('#show-npm-props').click(function(e) {
                e.preventDefault() // don't trigger normal click event
                $('#main-props').hide()
                $('#adv-props').hide()
                $('#show-adv-props').html('<i class="fa fa-caret-right"></i> Advanced Settings')
                $('#npm-props').show()

                packageList()
            })
            // Hide the npm section, show the main section
            $('#npm-close').click(function(e) {
                e.preventDefault() // don't trigger normal click event

                // Empty the msgbox & hide it
                $('#npm-response').html('').hide()

                $('#main-props').show()
                $('#npm-props').hide()
            })
            // Run the install command
            $('#npm-install').click(function(e) {
                e.preventDefault() // don't trigger normal click event

                // Empty the msgbox & hide it
                $('#npm-response').html('').hide(); npmMsg = []

                // If packagename empty, don't bother
                var packageName = $('#npm-package-name').val()
                if ( packageName !== '' ) {
                    $.get( 'uibnpm?cmd=install&package=' + packageName , function(data){ // + '&url=' + url
                        console.log( '[uibuilder:npm-install:get] Success. Package: ', packageName, data )
                        if (data.check.package_exists === false) {
                            npmMsg.push('Requested package could not be installed.')
                        } else {
                            npmMsg.push('Package added.')
                        }
                        // TODO Add to .settings.json
                    }).fail(function(jqXHR, textStatus, errorThrown) {
                        console.error( '[uibuilder:npm-remove:get] Package:' + packageName + '. Error ' + textStatus, errorThrown )
                        npmMsg.push('Error returned: ' + textStatus)
                    }).always(function(){
                        $('#npm-response').html('<p>' + npmMsg.join('<br>') + '</p>').show()
                        packageList() // refresh the package list    
                    })
            }
            })
            // Run the remove command
            $('#npm-remove').click(function(e) {
                e.preventDefault() // don't trigger normal click event

                // Empty the msgbox & hide it
                $('#npm-response').html('').hide(); npmMsg = []

                // If packagename empty, don't bother
                var packageName = $('#npm-package-name').val()
                if ( packageName !== '' ) {
                    $.get( 'uibnpm?cmd=remove&package=' + packageName , function(data){ // + '&url=' + url
                        console.log( '[uibuilder:npm-remove:get] Success. Package: ', packageName, data )
                        if (data.check.package_exists === false) {
                            npmMsg.push('Requested package does not exist.')
                        } else {
                            npmMsg.push('Package removed.')
                        }
                    }).fail(function(jqXHR, textStatus, errorThrown) {
                        console.error( '[uibuilder:npm-remove:get] Package:' + packageName + '. Error ' + textStatus, errorThrown )
                        npmMsg.push('Error returned: ' + textStatus)
                    }).always(function(){
                        $('#npm-response').html('<p>' + npmMsg.join('<br>') + '</p>').show()
                        packageList() // refresh the package list    
                    })
            }
            })
            //#endregion ---- npm ---- //

            /** TODO: Get list of installed ACE themes, add chooser, save current choice
             * that.editor.setTheme("ace/theme/monokai")
             * uiace.config.set("basePath", "https://url.to.a/folder/that/contains-ace-modes");
             * uiace.config.setModuleUrl("ace/theme/textmate", "url for textmate.js");
             **/

        }, // ---- End of oneditprepare ---- //

        oneditsave: function() {
            // xfer the editor text back to the template var
            //$('#node-input-template').val(this.editor.getValue())
            // Get rid of the editor
            if ( uiace.editorLoaded === true ) {
                uiace.editor.destroy()
                delete uiace.editor
                uiace.editorLoaded = false
            }
        },

        oneditcancel: function() {
            // Get rid of the editor
            if ( uiace.editorLoaded === true ) {
                uiace.editor.destroy()
                delete uiace.editor
                uiace.editorLoaded = false
            }
        },

        /** Handle window resizing for the editor */
        oneditresize: function(size) {
            //console.log('RESIZE', size)
            if ( uiace.editorLoaded === true ) {
                /**
                 * #node-input-template-editor
                 * #editor-stack > div > div.editor-tray-body-wrapper > div > div:nth-child(2) > div:nth-child(1)
                 *    .editor-tray-content
                 */
                /** Tries to make sure the editor+other visible components don't overflow (cause scroll) 
                 * Limited by min-height.
                */
                var rows = $('#dialog-form>div:not(.node-text-editor-row)')
                var height = $('#dialog-form').height()
                for (var i=0; i<rows.length; i++) {
                    height -= $(rows[i]).outerHeight(true)
                }
                var editorRow = $("#dialog-form>div.node-text-editor-row")
                height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")))
                //$('.node-text-editor').css('height',height+'px')
                $('#node-input-template-editor').css('height',height+'px')
                uiace.editor.resize()
            }
        },
    })

</script>

<script type="text/x-red" data-template-name="uibuilder">
    <div id="main-props"><!-- Hideable main properties section -->
        <!-- Node Name -->
        <div class="form-row">
            <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
            <input type="text" id="node-input-name">
        </div>

        <!-- Topic -->
        <div class="form-row" title="Adds a msg.topic to input msgs if not already provided">
            <label for="node-input-topic"><i class="fa fa-tasks"></i> Topic</label>
            <input type="text" id="node-input-topic">
        </div>

        <!-- Home "page" id - defines the URL used -->
        <div class="form-row" title="Make sure this gives a unique URL">
            <label for="node-input-url"><i class="fa fa-globe"></i> URL</label>
            <input type="text" id="node-input-url" title="required, <20 chars, unique, cannot be 'templates'">
        </div>

        <!-- Package List -->
        <div class="form-row">
            <ol id="node-input-packageList"></ol>
        </div>

        <!-- Allow scripts/styles to be passed to front-end? -->
        <div class="form-row" title="Add msg.script/msg.style to the input msg">
            Allow passing to the front-end: 
            <input type="checkbox" id="node-input-allowScripts" style="display: inline-block; width: auto; vertical-align: top;">
            <label for="node-input-allowScripts" style="">Scripts? (JS)</label>
            <input type="checkbox" id="node-input-allowStyles" style="display: inline-block; width: auto; vertical-align: top;">
            <label for="node-input-allowStyles" style="">Styles? (CSS)</label>
        </div>

        <!-- Copy index.(html|css|js) to local assets if they dont exist? -->
        <div class="form-row">
            <input type="checkbox" id="node-input-copyIndex" style="display: inline-block; width: auto; vertical-align: top;">
            <label for="node-input-copyIndex" style="width: 90%;">Copy index.(html|css|js) from templates to this instance if they don't exist?</label>
        </div>

        <!-- Show edit properties, hide this section -->
        <div class="form-row">
            <button class="btn" id="show-edit-props" title="Edit the front-end code">Edit Source Files</button>
            <button class="btn" id="show-npm-props" title="Install/remove/update npm packages to use with your UI">Manage front-end libraries</button>
        </div>

        <!-- Show advanced edit properties -->
        <div class="form-row">
            <h4 id="show-adv-props" title="Show/Hide the advanced configuration settings">
                <i class="fa fa-caret-right"></i> Advanced Settings
            </h4>
        </div>

    </div>

    <!-- ---- Hideable Advanced Settings Section ---- -->
    <div id="adv-props" style="display:hidden">
        <div class="form-tips node-help" title="">
            Warning: Most people will not need these settings.
        </div>
        <!-- Forward and debug flags -->
        <div class="form-row">
            <!-- Forward input msgs to output -->
            <input type="checkbox" id="node-input-fwdInMessages" style="display: inline-block; width: auto; vertical-align: top;">
            <label for="node-input-fwdInMessages" style="width: 40%;" title="forward inbound msg's direct to the output">
                Forward input to output?
            </label>
            <!-- Debug Front-End? -->
            <input type="checkbox" id="node-input-debugFE" style="display: inline-block; width: auto; vertical-align: top;">
            <label for="node-input-debugFE" style="width: 40%;" title="Turn on debugging in the front-end library">
                Debug Front-End?
            </label>
        </div>
    </div>

    <!-- ---- Hideable File Editor Section ---- -->
    <div id="edit-props">
        <!-- Drop-down for selecting folder -->
        <div class="form-row">
            <label for="node-input-folder"><i class="fa fa-folder-open-o"></i> Folder:</label>
            <select id="node-input-folder" style="width: 75%;">
                <option value="src">src</option>
                <option value="dist">dest</option>
                <option value="root">root</option>
            </select>
        </div>
        <!-- Drop-down for selecting file to edit -->
        <div class="form-row">
            <label for="node-input-filename"><i class="fa fa-file-code-o"></i> File:</label>
            <select id="node-input-filename" style="width: 75%;"></select>
        </div>

        <!-- Save/Cancel/Reset/(message)/Delete -->
        <div class="form-row">
            <button class="btn" id="edit-save" title="Save any changes to the file" style="font-size:0.8em;line-height:1em;">Save</button>
            <button class="btn" id="edit-reset" title="Reset any changes to last saved version (cancel changes)" style="font-size:0.8em;line-height:1em;">Reset</button>
            <button class="btn" id="edit-close" title="Close the edit window (lose any unsaved changes)" style="font-size:0.8em;line-height:1em;">Close</button>

            <span id="file-action-message"></span>

            <div style="position: absolute;right:1.6em;display:inline-block;">
                <button class="btn" id="edit-delete" title="Delete the file. Will reset to the default template if Copy from templates flag is set." style="font-size:0.8em;line-height:1em;">
                    Delete
                </button>
            </div>

        </div>

        <!-- Edit box  editor-tray-content -->
        <div id="edit-outer" class="form-row node-text-editor-row" style="position:relative">
            <div style="height: 350px; min-height:150px;" class="node-text-editor" id="node-input-template-editor" ></div>
            <div id="edit-drag-y" class="red-ui-panels-separator" style="position: relative;"></div>
        </div>

        <!-- file data (hidden), language selector -->
        <div class="form-row">
            <button id="node-function-expand-js" class="editor-button editor-button-small"><i class="fa fa-expand"></i></button>
            <input type="hidden" id="node-input-template" autofocus="autofocus" data-isClean="true">
            <div style="position: absolute; right:1.6em;display:inline-block; text-align: right; font-size: 0.8em;">
                <select id="node-input-format" style="width:110px; font-size: 10px !important;  height: 24px; padding:0;">
                    <option value="handlebars">mustache</option>
                    <option value="html">HTML</option>
                    <option value="json">JSON</option>
                    <option value="javascript">Javascript</option>
                    <option value="css">CSS</option>
                    <option value="markdown">Markdown</option>
                    <option value="yaml">YAML</option>
                    <option value="text">Text</option>
                </select>
            </div>
        </div>
    </div>

    <!-- ---- Hideable NPM Section ---- -->
    <div id="npm-props">
        <h3>Manage Front-End Libraries</h3>
        <p>
            Install, remove or update npm packages that provide front-end libraries such as
            VueJS, jQuery, MoonJS, etc.
        </p>
        <p>
            You can search for packages on the 
            <a href="https://www.npmjs.com/" target="_blank">official npm site</a> 
            or on <a href="https://npms.io/" target="_blank">npms.io</a>.
            Take the name and paste it below then use one of the buttons.
        </p>
        <!-- npm package name -->
        <div class="form-row">
            <label for="npm-package-name"><i class="fa fa-cube"></i> Package:</label>
            <input type="text" id="npm-package-name">
            <div id="npm-response" class="form-tips node-help"></div>
        </div>

        <!-- Install/Remove/Update -->
        <div class="form-row">
            <button class="btn" id="npm-install">Install</button>
            <button class="btn" id="npm-update">Update</button>
            <button class="btn" id="npm-remove">Remove</button>
            <button class="btn" id="npm-close">Close</button>
        </div>

        <!-- Installed packages -->
        <div>
            <h4>Installed Packages</h4>
            <ul class="inline" id="installed-packages"></ul>
        </div>
    </div>

    <!-- Info -->
    <h4 id="show-info-props" title="Show/Hide the available paths &amp; module information">
        <i class="fa fa-caret-right"></i> Path &amp; Module Details
    </h4>
    <div id="info-props" class="form-tips node-help" title="">
        <div>Web Page URL: <span id="uibuilderurl"></span></div>
        <div><a href="uibindex" target="_blank" title="Opens in a new tab">Detailed Information</a></div>
        <div>
            Click on the detailed info link to see details of what front-end libraries
            are available to your web pages. It also shows a list of all uibuilder web pages
            and some detailed uibuilder information.
        </div>
        <div>Front-end modules must be installed to your <i id="showuserdir">userDir</i> folder.</div>
    </div>
</script>

<script type="text/x-red" data-help-name="uibuilder">
    <p>Easily create a UI at a <a href="/uibuilder">given URL</a></p>
    <p>
        Create dynamic user interfaces that send and receive messages to/from Node-RED.
        Creates a file/folder structure that is used to deliver static resources (html, css, js, images, etc) and
        manages the delivery of vendor library resources (VueJS, jQuery, etc).
        You can also pass script and style information to the front-end in a message.
    </p>

    <h3>Input msg</h3>
    <dl class="message-properties">
        <dt class="optional">payload <span class="property-type">(string | buffer)</span></dt>
        <dd> Optionally, the payload of the message to publish. </dd>
        <dt class="optional">topic <span class="property-type">(string)</span></dt>
        <dd> Optionally, the MQTT topic to use. Takes preference over the topic defined in settings.</dd>

        <dt class="optional">script <span class="property-type">(string | string[])</span></dt>
        <dd>
        Optionally, a string or array of strings containing valid JavaScript.
        This will be added to the web page dynamically. Currently contains minimal validation so care is required.
        </dd>
        <dt class="optional">style <span class="property-type">(string | string[])</span></dt>
        <dd>
        Optionally, a string or array of strings containing valid CSS for styling the front-end page.
        This will be added to the web page dynamically. Currently contains minimal validation so care is required.
        </dd>
    </dl>

    <h3>Output msgs</h3>
    <ol class="node-ports">
        <li>Standard output msg
            <dl class="message-properties">
                <dt>_msgcounter <span class="property-type">(integer)</span></dt>
                <dd>
                    The number of messages received by the node instance since either the last reset of Node-RED or the last deployment of the node instance.
                </dd>
                <dt>payload <span class="property-type">(string | buffer)</span></dt>
                <dd>
                    A copy of any inbound payload unless altered by the front-end page.
                </dd>
                <dt>topic <span class="property-type">(string)</span></dt>
                <dd>
                    A copy of any inbound topic if present. Otherwise, the topic from the node's settings. Could be changed by the front-end
                    page but it really isn't recommended.
                </dd>
                <dt>other</dt>
                <dd>
                    Note that any inbound msg.script or msg.style is stripped and not sent to the output.
                </dd>
            </dl>
        </li>
        <li>Control output msg
            <dl class="message-properties">
                <dt>uibuilderCtrl <span class="property-type">(string)</span></dt>
                <dd>
                    The name of the control message. See the
                    <a href="https://github.com/TotallyInformation/node-red-contrib-uibuilder/wiki/Control-Message-Structure">WIKI page</a>
                    for details.
                </dd>
                <dt>cache-control <span class="property-type">(string)</span></dt>
                <dd>
                    "REPLAY". A command for the companion app
                    <a href="https://github.com/TotallyInformation/node-red-contrib-infocache">node-red-contrib-infocache</a>.
                    See the
                    <a href="https://github.com/TotallyInformation/node-red-contrib-uibuilder/wiki/Message-Caching">WIKI</a>
                    for details.
                </dd>
            </dl>
    </ol>

    <h3>Node Settings</h3>
    <dl class="message-properties">
        <dt>Name <span class="property-type">(string) node-input-name</span></dt>
        <dd>A short description shown in the admin interface</dd>
        <dt>Topic <span class="property-type">(string) node-input-topic</span></dt>
        <dd>A topic name to use if the incoming msg does not contain one.</dd>
        <dt>URL <span class="property-type">(string) node-input-url</span></dt>
        <dd>
            The URL path that the resulting page and other resources will be served from.
            Must be unique across Node-RED. Will also use the Node-RED scheme (http/https)
            and port. Will also be prefixed by the Node-RED setting.<br>
            The default URL is <a href="/uibuilder">/uibuilder</a>.<br>
            The url is also used to define the server filing system path for front-end code files.<br>
            The url must be valid as a filename as well as a url path. It may not exceed 20 characters.
        </dd>
        <dt>Forward received messages direct to output? <span class="property-type">(boolean) node-input-fwdInMessages</span></dt>
        <dd>
            Forward's a copy of every received message direct to the output.
            Adds the topic from the above setting if one isn't present in the msg.
            <p>
                <i>Note</i> that this may result in multiple output messages if your front-end
                code also auto-sends inbound messages.
            </p>
        </dd>

        <dt>Allow scripts to be passed to front-end? <span class="property-type">(boolean) allowScripts</span></dt>
        <dd>
            If on, any string(s) in <code>msg.script</code> will be dynamically added to the scripts of the web page.
            Turn off to prevent scripts from being dynamically added and executed.
        </dd>
        <dt>Allow styles to be passed to front-end? <span class="property-type">(boolean) allowStyles</span></dt>
        <dd>
            If on, any string(s) in <code>msg.style</code> will be dynamically added to the styles of the web page.
            Turn off to prevent styles from being dynamically added.
        </dd>

        <dt>Copy index.(css|js) from templates to local if they don't exist?
            <span class="property-type">(boolean) node-input-copyIndex</span>
        </dt>
        <dd>
            If on (default), index.(css|html|js) files are copied from the master template folder
            if they don't exist in the local assets folder <code>~/.node-red/uibuilder/<url>/src/</code>.
            Turn off if you don't want this to happen (e.g. if you prefer them in a sub-folder).
        </dd>

        <dt>Debug Front-End? <span class="property-type">(boolean) debugFE</span></dt>
        <dd>
            Turns on debugging in the front-end code. See your browser's developer tools console.
            In your index.js front-end code, use <code>uibuilder.debug()</code> to detect whether debugging is on or off
            and <code>uibuilder.debug(true)</code> to turn it on.<br>
            The chosen state is sent to the Front-end in the initial connection message.<br>
            <b>Note</b>: The flag in <code>settings.js</code> controls debug output for the back-end (see below).
        </dd>

        <dt>Edit Source Files (button)</dt>
        <dd>
            Clicking this button will hide the above settings and display a file editor allowing you
            to edit the front-end files that define your user interface.<br>
            All text-based files in the `<userDir>/uibuilder/<url>/src` folder on the server's filing system will
            be available to edit.
        </dd>
    </dl>

    <h3>Node-RED Settings</h3>
    <p>
        Some global settings are taken from `&lt;userDir&gt;/uibuilder/.settings.js`
    </p>
    <dl class="message-properties">
        <dt>userVendorPackages <span class="property-type">(string[])</span></dt>
        <dd>
            A list of package names that must match the folder name of an npm package
            installed in the <code>userDir</code> of Node-RED. These will be added to
            the list of statically served resource folders <b>if</b> the local <code>src</code>
            folder is being used and the "Use resources in custom folder?" setting is checked.
        </dd>
        <dt>debug <span class="property-type">(boolean)</span></dt>
        <dd>
            Turns on/off back-end debugging for all instances of the uibuilder node.
            This flag is picked up earlier than the on in the node settings and so may show more information.
            This flag is overridden by the node instance settings but at a later stage of operation so some output is still expected.
        </dd>
    </dl>

    <h3>File/Folder Structure</h3>
    <p>
        For more information, see the GitHub page for <a href="https://github.com/TotallyInformation/node-red-contrib-uibuilder">node-red-contrib-uibuilder</a>
    </p>


    <h3>Details</h3>
    <p>
        For more information, see the GitHub page for <a href="https://github.com/TotallyInformation/node-red-contrib-uibuilder">node-red-contrib-uibuilder</a>
    </p>
    <p>
        There are also examples of how to use uibuilder in the <a href="https://github.com/TotallyInformation/node-red-contrib-uibuilder/wiki">GitHub WIKI</a>.
    </p>
    <p>
        uibuilder can be discussed in the <a href="https://groups.google.com/forum/#!topic/node-red">Node-RED Google Group</a> and in the <a href="https://node-red.slack.com/messages/C7K77MG06">Node-RED #uibuilder Slack channel</a>. Issues/bugs can be raised in <a href="https://github.com/TotallyInformation/node-red-contrib-uibuilder/issues">GitHub</a>.
    </p>

    <h3><a href="uibindex">&lt;admin url&gt;/uibindex</a> page</h3>
    <p>
        Lists all of the uibuilder endpoints. You can use the following parameters:
    </p>
    <dl class="message-properties">
        <dt>type <span class="property-type">(string)</span></dt>
        <dd>
            The type of the data returned.
            <dl class="message-properties">
                <dt>html <span class="property-type">(default)</span></dt>
                <dd>
                    Also used if no type parameter is given. 
                    Returns an HTML page showing the details for all deployed uibuilder nodes.
                    Shows the server file locations of the instance and for vendor libraries.
                </dd>
                <dt>json</dt>
                <dd>
                    Returns JSON data with both the source node ID's and matching URL's.
                </dd>
                <dt>urls</dt>
                <dd>
                    Returns a JSON array of just the URL's in use from deployed uibuilder nodes.
                    Used internally to ensure that new nodes use unique url's.
                </dd>
            </dl>
        </dd>

        <dt>check <span class="property-type">(string)</span></dt>
        <dd>
            Passing a uibuilder instance name to the check parameter will result in a boolean (true/false)
            return. True if it is being delivered by a uibuilder instance,
            false otherwise. e.g. <code>?check=uibuilder</code>
        </dd>
    </dl>
    <ul>
    </ul>

</script>
